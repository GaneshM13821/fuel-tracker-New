<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Tracker 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Manrope:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body {
      min-height: 100vh;
      font-family: 'Inter', 'Manrope', Arial, sans-serif;
      background: linear-gradient(135deg, #f7fafc 0%, #e0e7ff 100%);
    }
    .glass-card {
      background: rgba(255,255,255,0.96);
      border-radius: 2rem;
      box-shadow: 0 8px 36px 0 rgba(99,102,241,0.10), 0 2px 24px 0 rgba(6,182,212,0.11);
      border: 2px solid #e0e7ff;
      position: relative;
      margin-bottom: 2rem;
      transition: box-shadow .3s;
    }
    .glass-card:hover {
      box-shadow: 0 16px 48px 0 #6366f122, 0 2px 36px 0 #06b6d433;
      border-color: #6366f1;
    }
    .header-gradient {
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      box-shadow: 0 4px 24px #6366f111;
      border-bottom-left-radius: 2.2rem;
      border-bottom-right-radius: 2.2rem;
    }
    .navbar-brand {
      font-size: 2.5rem;
      font-family: 'Manrope', 'Inter', sans-serif;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 2px 8px #6366f1cc;
    }
    .sync-status {
      position: absolute;
      top: 22px;
      right: 36px;
      font-size: 1rem;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 32px;
      box-shadow: 0 2px 12px #06b6d433;
      color: #fff;
      z-index: 10;
      background: linear-gradient(90deg, #22c55e 0%, #06b6d4 100%);
      border: 1.5px solid #fff8;
      animation: pulseSync 2.5s infinite;
    }
    @keyframes pulseSync {
      0%,100%{box-shadow:0 2px 12px #06b6d433,0 0 0 7px #fff4;}
      50%{box-shadow:0 2px 24px #6366f144,0 0 0 12px #06b6d433;}
    }
    .btn-glass {
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      color: #fff !important;
      border-radius: 32px;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 2px 10px #6366f122;
      border: none;
      transition: background .18s, transform .18s;
    }
    .btn-glass:hover {
      background: linear-gradient(90deg, #06b6d4 0%, #6366f1 100%);
      color: #fff !important;
      transform: scale(1.06);
      box-shadow: 0 4px 24px #6366f144;
    }
    .toggle-btn-group {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 18px;
    }
    .toggle-btn {
      padding: 10px 28px;
      border-radius: 50px;
      border: none;
      font-weight: 700;
      font-size: 1.1rem;
      background: #e0e7ff;
      color: #6366f1;
      transition: background .22s, color .18s, box-shadow .18s;
      box-shadow: 0 2px 10px #6366f122;
    }
    .toggle-btn.active {
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      color: #fff;
      box-shadow: 0 6px 18px #06b6d433;
      font-size: 1.15rem;
      border: 2px solid #fff8;
    }
    .divider {
      height: 4px;
      border-radius: 2px;
      margin: 22px 0 26px 0;
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      opacity: .8;
    }
    .table-responsive {
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 16px #6366f111;
      margin-bottom: 1.4rem;
      background: rgba(255,255,255,0.98);
    }
    .table th, .table td {
      vertical-align: middle;
      text-align: center;
      font-size: 1rem;
      padding: 8px 12px;
      border-bottom: 2px solid #e0e7ff;
    }
    .table thead {
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      border-bottom: 2px solid #e0e7ff;
    }
    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: #e0e7ff22;
    }
    .table-hover > tbody > tr:hover {
      background: linear-gradient(90deg, #e0e7ff 0%, #f7fafc 100%);
    }
    .action-btn {
      font-weight: 700;
      border-radius: 22px;
      font-size: 1rem;
      padding: 5px 16px;
      box-shadow: 0 1px 6px #6366f122;
      background: #fff;
      color: #06b6d4;
      border: 2px solid #06b6d466;
      transition: background .18s, color .18s, transform .15s;
      margin: 2px;
    }
    .action-btn.edit { color: #6366f1; border-color: #6366f199;}
    .action-btn.delete { color: #ef4444; border-color: #ef444466;}
    .action-btn:hover { background: linear-gradient(90deg, #06b6d4 0%, #6366f1 100%); color: #fff; transform: scale(1.08);}
    .summary-progress {
      height: 22px;
      border-radius: 12px;
      overflow: hidden;
      background: #e0e7ff;
      margin-bottom: 1.2rem;
    }
    .summary-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
      color: #fff;
      font-weight: 700;
      text-align: right;
      padding-right: 14px;
      line-height: 22px;
      font-size: 1rem;
      box-shadow: 0 2px 12px #6366f122;
      transition: width .6s cubic-bezier(.77,.2,.25,1);
    }
    .monthly-summary-badge {
      font-size: 1rem;
      background: linear-gradient(90deg, #06b6d4 0%, #6366f1 100%);
      color: #fff;
      border-radius: 1rem;
      padding: 6px 20px;
      font-weight: 700;
      margin-right: 12px;
      box-shadow: 0 2px 8px #06b6d433;
    }
    /* Section toggle logic */
    .entry-form-section { display: none; }
    .entry-form-section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 600px) {
      .glass-card, .table-responsive { padding: 8px !important; }
      .toggle-btn { padding: 10px 10px; font-size: .95rem; }
      .table th, .table td { font-size: 0.80rem; padding: 6px 3px; }
      .navbar-brand { font-size: 1.4rem;}
    }
	.settings-panel {
	  display: none;
	  background: #fff;
	  padding: 20px;
	  border-radius: 1.5rem;
	  box-shadow: 0 4px 18px rgba(99,102,241,0.12);
	  margin: 16px auto;
	  max-width: 400px;
	  text-align: center;
	  border: 2px solid #e0e7ff;
	}
	.settings-panel label {
	  font-weight: 700;
	  margin-right: 8px;
	  color: #6366f1;
	}
	.settings-panel input {
	  padding: 8px 12px;
	  border-radius: 8px;
	  border: 1.5px solid #e0e7ff;
	  width: 130px;
	  font-size: 1rem;
	  background: #f7fafc;
	}
  </style>
</head>
<body>
	
  <nav class="navbar navbar-expand-lg header-gradient shadow-lg mb-4">
    <div class="container-fluid position-relative">
      <span class="navbar-brand d-flex align-items-center gap-3">
        <i class="bi bi-fire fs-1" style="color:#facc15;"></i>
        Fuel Tracker
      </span>
      <span id="syncStatus" class="sync-status">ðŸŸ¢ Online</span>
    </div>
  </nav>
  	<div class="settings" style="text-align: right; margin: 10px;">
	  <button onclick="toggleSettings()" class="btn btn-glass" aria-label="Toggle settings">
		<i class="bi bi-gear-fill"></i> Settings
	  </button>
	</div>
	<div class="settings-panel" id="settingsPanel" style="display: none;">
	  <label for="bikeMileage"><i class="bi bi-speedometer"></i> Bike Mileage (km/L)</label>
	  <input type="number" id="bikeMileage" step="0.1" aria-label="Bike Mileage" style="margin-left:10px;">
	  <div class="mt-3">
		<button onclick="saveSettings()" class="btn btn-success btn-glass me-2">
		  <i class="bi bi-save"></i> Save Settings
		</button>
		<button onclick="resetApp()" class="btn btn-danger btn-glass">
		  <i class="bi bi-trash"></i> Reset App
		</button>
	  </div>
	</div>
  <main class="container py-2">
    <!-- Toggle Buttons -->
    <div class="toggle-btn-group my-3">
      <button id="toggleFuelBtn" class="toggle-btn active" onclick="showEntryForm('fuel')">
        <i class="bi bi-fuel-pump-fill"></i> Fuel Meter Entry
      </button>
      <button id="toggleCostBtn" class="toggle-btn" onclick="showEntryForm('cost')">
        <i class="bi bi-cash-stack"></i> Cost Expenditure
      </button>
    </div>
    <div class="divider"></div>
    <!-- Fuel Meter Entry Section -->
    <section id="fuelMeterSection" class="entry-form-section active">
      <!-- Summary Card -->
      <div class="glass-card mb-3 p-4">
        <div class="card-header">
          <h4 class="fw-bold mb-2" style="color:#6366f1;">
            <i class="bi bi-graph-up-arrow fs-2 me-2"></i> Current Fuel Status
          </h4>
        </div>
        <div id="totalsSummary" class="fs-4 text-center">Available Fuel: <span style="color:#06b6d4;">12.5L</span></div>
        <div class="summary-progress mt-3">
          <div id="fuelProgressBar" class="summary-progress-bar" style="width:60%;">Fuel Level</div>
        </div>
      </div>
      <!-- Entry Form -->
      <div class="glass-card mb-3 p-4">
        <div class="card-header">
          <h5 class="fw-bold mb-2" style="color:#06b6d4;">
            <i class="bi bi-pencil-square me-2"></i> Fuel Meter Entry
          </h5>
        </div>
        <form id="fuelForm" autocomplete="off">
          <div class="row g-4">
            <div class="col-md-2 col-6">
              <label for="date" class="form-label">Date</label>
              <input type="date" id="date" class="form-control" required>
            </div>
            <div class="col-md-2 col-6">
              <label for="meterStart" class="form-label">Meter Start</label>
              <input type="number" id="meterStart" class="form-control" step="0.1" required>
            </div>
            <div class="col-md-2 col-6">
              <label for="meterEnd" class="form-label">Meter End</label>
              <input type="number" id="meterEnd" class="form-control" step="0.1" required>
            </div>
            <div class="col-md-2 col-6">
              <label for="distance" class="form-label">Distance</label>
              <input type="number" id="distance" class="form-control" step="0.1" readonly>
            </div>
            <div class="col-md-2 col-6">
              <label for="fuel" class="form-label">Fuel Added (L)</label>
              <input type="number" id="fuel" class="form-control" step="0.01" required>
            </div>
            <div class="col-md-2 col-6">
              <label for="cost" class="form-label">Cost (â‚¹)</label>
              <input type="number" id="cost" class="form-control" step="0.01" required>
            </div>
            <div class="col-md-2 col-6">
              <label for="remainingKm" class="form-label">Remaining KM</label>
              <input type="number" id="remainingKm" class="form-control" step="0.1" readonly>
            </div>
            <div class="col-12 text-center mt-3">
              <button type="submit" class="btn btn-success btn-glass px-4 me-2">
                <i class="bi bi-save"></i> Save Entry
              </button>
              <button type="button" id="cancelEditBtn" class="btn btn-secondary btn-glass px-4" style="display:none;">Cancel Edit</button>
            </div>
          </div>
        </form>
      </div>
      <!-- Records Table -->
      <div class="glass-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="fw-bold mb-0" style="color:#6366f1;"><i class="bi bi-journal-text me-2"></i> Fuel Meter Records</h5>
          <button onclick="exportCSV()" class="btn btn-primary btn-glass px-3">
            <i class="bi bi-download"></i> Export CSV
          </button>
        </div>
        <div class="table-responsive">
          <table id="fuelMeterTable" class="table table-hover table-striped rounded-3 overflow-hidden">
            <thead>
              <tr>
                <th>Date</th>
                <th>Start</th>
                <th>End</th>
                <th>Distance</th>
                <th>Fuel Used</th>
                <th>Fuel Added</th>
                <th>Cost</th>
                <th>Available Fuel</th>
                <th>Remaining KM</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Cost Expenditure Section -->
    <section id="costSection" class="entry-form-section">
      <div class="glass-card mb-3 p-4">
        <div class="card-header">
          <h4 class="fw-bold mb-2" style="color:#06b6d4;">
            <i class="bi bi-cash-coin fs-2 me-2"></i> Cost Summary
          </h4>
        </div>
        <div id="costSummary" class="fs-5 text-center"></div>
        <div class="summary-progress mt-3">
          <div id="costProgressBar" class="summary-progress-bar" style="width:45%;">Monthly Cost</div>
        </div>
      </div>
      <div class="glass-card mb-3 p-4">
        <div class="card-header">
          <h5 class="fw-bold mb-2" style="color:#6366f1;">
            <i class="bi bi-pencil-square me-2"></i> Cost Expenditure
          </h5>
        </div>
        <form id="costForm" autocomplete="off">
          <div class="row g-4">
            <div class="col-md-3 col-6">
              <label for="costDate" class="form-label">Date</label>
              <input type="date" id="costDate" class="form-control" required>
            </div>
            <div class="col-md-3 col-6">
              <label for="costItem" class="form-label">Item</label>
              <select id="costItem" class="form-select" required>
                <option value="Petrol">Petrol</option>
                <option value="Goods">Goods</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Others">Others</option>
              </select>
            </div>
            <div class="col-md-3 col-6" id="costSubItemDiv" style="display:none;">
              <label for="costSubItem" class="form-label">Details</label>
              <select id="costSubItem" class="form-select">
                <!-- Options loaded by JS -->
              </select>
            </div>
            <div class="col-md-3 col-6">
              <label for="costAmount" class="form-label">Cost (â‚¹)</label>
              <input type="number" id="costAmount" class="form-control" step="0.01" required>
            </div>
            <div class="col-12 text-center mt-3">
              <button type="submit" class="btn btn-success btn-glass px-4 me-2">
                <i class="bi bi-save"></i> Save Cost
              </button>
              <button type="button" id="cancelCostEditBtn" class="btn btn-secondary btn-glass px-4" style="display:none;">Cancel Edit</button>
            </div>
          </div>
        </form>
      </div>
      <div class="glass-card p-4 mb-4">
        <h5 class="fw-bold mb-2" style="color:#06b6d4;"><i class="bi bi-journal-text me-2"></i> Cost Expenditure Records</h5>
        <div class="table-responsive">
          <table id="costTable" class="table table-hover table-striped rounded-3 overflow-hidden">
            <thead>
              <tr>
                <th>Date</th>
                <th>Item</th>
                <th>Details</th>
                <th>Cost (â‚¹)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <div class="divider"></div>
    <div class="glass-card p-4 mb-5">
      <h5 class="fw-bold mb-3" style="color:#6366f1;">
        <i class="bi bi-calendar-range fs-2 me-2"></i> Monthly Summaries
      </h5>
      <div id="monthlySummary"></div>
      <span class="monthly-summary-badge mt-3 mb-2">Up to Date!</span>
    </div>
  </main>
  <div id="toast" class="toast">âœ… Saved successfully</div>
  <script type="module">
	
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

	window.toggleSettings = function() {
	  let p = document.getElementById('settingsPanel');
	  p.style.display = (p.style.display === 'block') ? 'none' : 'block';
	};

	window.saveSettings = function() {
	  const mileageInput = Number(document.getElementById('bikeMileage').value) || 40;
	  BIKE_MILEAGE = mileageInput > 0 ? mileageInput : 40;
	  localStorage.setItem('bikeMileage', BIKE_MILEAGE);
	  alert('Bike mileage updated to ' + BIKE_MILEAGE + ' km/L');
	  calcRemainingKm();
	  renderFuelMeterTable();
	  renderSummaries();
	  renderTotalsSummary();
	};

	window.resetApp = function() {
	  if (confirm('This will delete ALL records. Continue?')) {
		if (isFirebaseConfigured) {
		  alert("Please delete records individually when using cloud sync for safety.");
		} else {
		  records = [];
		  costRecords = [];
		  localStorage.removeItem('fuelRecords');
		  localStorage.removeItem('costRecords');
		  renderFuelMeterTable();
		  renderSummaries();
		  renderTotalsSummary();
		  renderCostTable();
		}
	  }
	};
    const firebaseConfig = {
      apiKey: "AIzaSyB-Og_0PuU-mQbMu4YpbdQlxBTP4Kexuqg",
      authDomain: "fuel-tracker-2982b.firebaseapp.com",
      projectId: "fuel-tracker-2982b",
      storageBucket: "fuel-tracker-2982b.appspot.com",
      messagingSenderId: "12406726460",
      appId: "1:12406726460:web:d0a9bdefe54cc957894839"
    };

    let BIKE_MILEAGE = Number(localStorage.getItem('bikeMileage')) || 40;
    let records = [];
    let editIndex = -1;
    let app, db;
    let isFirebaseConfigured = false;

    // --- Cost Expenditure State ---
    let costRecords = [];
    let costEditIndex = -1;

    // Utility functions
    const num = (v, def = 0) => { v = Number(v); return Number.isFinite(v) ? v : def; };
    const roundN = (v, n = 1) => Number(num(v, 0).toFixed(n));
    const clamp0 = v => Math.max(0, v);

    const subOptions = {
      "Goods": ["Powerbank", "Mobile Holder"],
      "Maintenance": ["Service", "Oil Change", "Spare Parts"]
    };

      document.getElementById("costItem").addEventListener("change", function() {
      const selected = this.value;
      const subDiv = document.getElementById("costSubItemDiv");
      const subSelect = document.getElementById("costSubItem");
    
      if (subOptions.hasOwnProperty(selected)) {
        // show dropdown and load options
        subSelect.innerHTML = subOptions[selected]
          .map(opt => `<option value="${opt}">${opt}</option>`)
          .join("");
        subDiv.style.display = "block";
      } else {
        // hide completely
        subDiv.style.display = "none";
        subSelect.innerHTML = "";
      }
    });
	
    // Toggle sections logic
    window.showEntryForm = function(type) {
      document.getElementById('fuelMeterSection').classList.remove('active');
      document.getElementById('costSection').classList.remove('active');
      document.getElementById('toggleFuelBtn').classList.remove('active');
      document.getElementById('toggleCostBtn').classList.remove('active');
      if (type === 'fuel') {
        document.getElementById('fuelMeterSection').classList.add('active');
        document.getElementById('toggleFuelBtn').classList.add('active');
      } else {
        document.getElementById('costSection').classList.add('active');
        document.getElementById('toggleCostBtn').classList.add('active');
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      showEntryForm('fuel');
      document.getElementById('bikeMileage').value = BIKE_MILEAGE;
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('costDate').value = new Date().toISOString().split('T')[0];
      initFirebase();
      document.getElementById('cancelEditBtn').addEventListener('click', window.cancelEdit);
      document.getElementById('cancelCostEditBtn').addEventListener('click', window.cancelCostEdit);
      document.getElementById('fuelMeterSection').classList.remove('active');
      document.getElementById('costSection').classList.remove('active');
      showEntryForm('fuel');
    });

    document.getElementById('meterEnd').addEventListener('input', () => { calcDistance(); calcRemainingKm(); });
    document.getElementById('meterStart').addEventListener('input', () => { calcDistance(); calcRemainingKm(); });
    document.getElementById('fuel').addEventListener('input', calcRemainingKm);

    document.getElementById('fuelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      updateSyncStatus('syncing');
      let start = roundN(document.getElementById('meterStart').value, 1);
      let end = roundN(document.getElementById('meterEnd').value, 1);
      if (end < start) { alert('End meter must be greater than start meter'); updateSyncStatus(isFirebaseConfigured ? 'online' : 'offline'); return; }
      let distance = roundN(end - start, 1);
      let fuel = roundN(document.getElementById('fuel').value, 2); // TWO DECIMAL PLACES PATCHED
      let cost = roundN(document.getElementById('cost').value, 2);
      let remainingKm = roundN(clamp0(document.getElementById('remainingKm').value), 1);
      let date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
      let record = { date, start, end, distance, fuel, cost, remainingKm };
      try {
        if (editIndex >= 0) {
          if (isFirebaseConfigured && db && records[editIndex].firebaseId) {
            await updateDoc(doc(db, 'fuelRecords', records[editIndex].firebaseId), record);
          } else if (!isFirebaseConfigured) {
            records[editIndex] = record;
            localStorage.setItem('fuelRecords', JSON.stringify(records));
            renderFuelMeterTable();
            renderSummaries();
            renderTotalsSummary();
          }
          editIndex = -1;
          document.getElementById('cancelEditBtn').style.display = 'none';
        } else {
          if (isFirebaseConfigured && db) {
            await addDoc(collection(db, 'fuelRecords'), record);
          } else if (!isFirebaseConfigured) {
            records.push(record);
            localStorage.setItem('fuelRecords', JSON.stringify(records));
            renderFuelMeterTable();
            renderSummaries();
            renderTotalsSummary();
          }
        }
        showToast('âœ… Saved successfully');
        e.target.reset();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        updateSyncStatus(isFirebaseConfigured ? 'online' : 'offline');
        window.calcDistance();
        window.calcRemainingKm();
      } catch {
        alert("Failed to save record. Please try again.");
        updateSyncStatus('offline');
      }
    });

    window.editRecord = function(i) {
      let r = records[i];
      document.getElementById('date').value = r.date || new Date().toISOString().split('T')[0];
      document.getElementById('meterStart').value = num(r.start).toFixed(1);
      document.getElementById('meterEnd').value = num(r.end).toFixed(1);
      document.getElementById('distance').value = num(r.distance).toFixed(1);
      document.getElementById('fuel').value = num(r.fuel).toFixed(2); // PATCHED TO TWO DECIMAL PLACES
      document.getElementById('cost').value = num(r.cost).toFixed(2);
      document.getElementById('remainingKm').value = clamp0(num(r.remainingKm)).toFixed(1);
      editIndex = i;
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
      window.showEntryForm('fuel');
    };

    window.cancelEdit = function() {
      editIndex = -1;
      document.getElementById('fuelForm').reset();
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('cancelEditBtn').style.display = 'none';
      window.calcDistance();
      window.calcRemainingKm();
    };

    window.deleteRecord = async function(i) {
      if (confirm('Delete this record?')) {
        try {
          updateSyncStatus('syncing');
          if (isFirebaseConfigured && db && records[i].firebaseId) {
            await deleteDoc(doc(db, 'fuelRecords', records[i].firebaseId));
          } else if (!isFirebaseConfigured) {
            records.splice(i, 1);
            localStorage.setItem('fuelRecords', JSON.stringify(records));
            renderFuelMeterTable();
            renderSummaries();
            renderTotalsSummary();
          }
          updateSyncStatus(isFirebaseConfigured ? 'online' : 'offline');
        } catch {
          alert("Failed to delete record. Please try again.");
          updateSyncStatus('offline');
        }
      }
    };

    // --- Cost Form Submit ---
    document.getElementById('costForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      updateSyncStatus('syncing');
      let date = document.getElementById('costDate').value || new Date().toISOString().split('T')[0];
      let item = document.getElementById('costItem').value;
      let cost = roundN(document.getElementById('costAmount').value, 2);
      let subItem = document.getElementById('costSubItem').value || '';
      let record = { date, item, subItem, cost };

      try {
        if (costEditIndex >= 0) {
          if (isFirebaseConfigured && db && costRecords[costEditIndex].firebaseId) {
            await updateDoc(doc(db, 'costRecords', costRecords[costEditIndex].firebaseId), record);
          } else if (!isFirebaseConfigured) {
            costRecords[costEditIndex] = record;
            localStorage.setItem('costRecords', JSON.stringify(costRecords));
            renderCostTable();
          }
          costEditIndex = -1;
          document.getElementById('cancelCostEditBtn').style.display = 'none';
        } else {
          if (isFirebaseConfigured && db) {
            await addDoc(collection(db, 'costRecords'), record);
          } else if (!isFirebaseConfigured) {
            costRecords.push(record);
            localStorage.setItem('costRecords', JSON.stringify(costRecords));
            renderCostTable();
          }
        }
        showToast('âœ… Cost saved');
        e.target.reset();
        document.getElementById('costDate').value = new Date().toISOString().split('T')[0];
        updateSyncStatus(isFirebaseConfigured ? 'online' : 'offline');
      } catch {
        alert("Failed to save cost record. Please try again.");
        updateSyncStatus('offline');
      }
    });

    window.renderSummaries = function() {
      let summaryDiv = document.getElementById('monthlySummary');
      summaryDiv.innerHTML = '';
      const computedRecords = computeAvailableFuel(records, BIKE_MILEAGE);
      let grouped = {};
      computedRecords.forEach(r => {
        let month = (r.date || '').substring(0, 7);
        if (!grouped[month]) grouped[month] = { distance: 0, fuel: 0, cost: 0, remaining: 0 };
        grouped[month].distance += num(r.distance);
        grouped[month].fuel += num(r.fuel);
        grouped[month].cost += num(r.cost);
        grouped[month].remaining += num(r.remainingKm);
      });
      for (let m in grouped) {
        const g = grouped[m];
        const avgMileage = g.fuel > 0 ? (g.distance / g.fuel).toFixed(2) : 'â€”';
        summaryDiv.innerHTML += `<p><b>${m}</b>: 
          ${g.distance.toFixed(1)} km, 
          ${g.fuel.toFixed(1)} L, 
          â‚¹${g.cost.toFixed(2)}, 
          Mileage: ${avgMileage} km/L, 
          Remaining: ${g.remaining.toFixed(1)} km</p>`;
      }
      renderTotalsSummary();
    };
  </script>
</body>
</html>
